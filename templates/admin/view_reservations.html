{% extends 'layout.html' %}

{% block style %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
<style>
    .reservation-container {
        max-width: 1400px;
        margin: 2rem auto;
        padding: 2rem;
        background: #041228;
        border-radius: 20px;
        border: 1px solid rgba(255,255,255,0.08);
        box-shadow: 0 8极狐 32px 0 rgba(31,38,135,0.18);
    }
    .filter-card {
        background: #171d2f;
        border-radius: 16px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        border: 1px solid rgba(255,255,255,0.08);
        box-shadow: 0 4px 16px 0 rgba(31,38,135,0.12);
    }
    .filter-card label {
        color: #bfc8e2;
        font-weight: 500;
    }
    .form-control, .form-select {
        background: #222b45;
        color: #e8eaf6;
        border: none;
        border-radius: 10px;
        font-size: 1rem;
        box-shadow: none;
    }
    .form-control::placeholder {
        color: #8a8fa3 !important;
        opacity: 1;
    }
    .btn-primary {
        background: #2563eb;
        border: none;
        border-radius: 8px;
        font-weight: 600;
    }
    .btn-primary:hover {
        background: #1d4ed8;
    }
    .btn-secondary {
        background: #374151;
        color: #e8eaf6;
        border-radius: 8px;
        border: none;
        font-weight: 600;
    }
    .btn-secondary:hover {
        background: #23272f;
        color: #fff;
    }
    .table-responsive {
        border-radius: 15px;
        overflow: hidden;
    }
    .reservation-table {
        width: 100%;
        background: #181f34;
        color: #e8eaf6;
        border-collapse: separate;
        border-spacing: 0;
    }
    .reservation-table th {
        background: #19213a;
        color: #fff;
        font-weight: 700;
        padding: 1rem 1.5rem;
        text-align: left;
        border-bottom: 2px solid #232b43;
    }
    .reservation-table td {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #232b43;
        vertical-align: middle;
    }
    .reservation-table tr {
        transition: background 0.2s;
    }
    .reservation-table tr:hover td {
        background: #212a47;
    }
    .badge-green {
        background: #22c55e;
        color: #fff;
        border-radius: 8px;
        padding: 0.3rem 0.8rem;
        font-weight: 600;
    }
    .badge-yellow {
        background: #facc15;
        color: #222b45;
        border-radius: 8px;
        padding: 0.3rem 0.8rem;
        font-weight: 极狐
    }
    .badge-red {
        background: #ef4444;
        color: #fff;
        border-radius: 8px;
        padding: 0.3rem 0.8rem;
        font-weight: 600;
    }
    .action-btn {
        border-radius: 8px;
        padding: 0.4rem 0.7rem;
        font-size: 1rem;
        margin-right: 0.2rem;
        transition: background 0.2s;
        border: none;
        cursor: pointer;
    }

    .action-btn.delete {
        background: #fecaca;
        color: #b91c1c;
    }

    .action-btn.delete:hover {
        background: #ef4444;
        color: #fff;
    }
    @media (max-width: 900px) {
        .reservation-table th, .reservation-table td { padding: 0.7rem; }
        .reservation-container { padding: 1rem; }
    }
</style>
{% endblock %}

{% block title %}
<title>Reservation Management - Admin</title>
{% endblock %}

{% block content %}
<div class="dashboard-header">
    <h2 class="page-title"><i class="fas fa-calendar-alt me-2"></i> Reservation Management</h2>
    <p class="page-subtitle">View and manage all parking reservations</p>
</div>

<div class="reservation-container">
    <!-- Filter Section -->
    <div class="filter-card">
        <form method="GET" class="row g-3" action="#reservations-table">
            <div class="col-md-3">
                <label class="form-label">Status</label>
                <select name="status" class="form-select">
                    <option value="">All Statuses</option>
                    <option value="Active" {{ 'selected' if current_status == 'Active' else '' }}>Active</option>
                    <option value="Released" {{ 'selected' if current_status == 'Released' else '' }}>Released</option>
                    <option value="Expired" {{ 'selected' if current_status == 'Expired' else '' }}>Expired</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Start Date</label>
                <input type="date" name="start_date" class="form-control" value="{{ current_start_date }}" placeholder="dd-mm-yyyy">
            </div>
            <div class="col-md-3">
                <label class="form-label">End Date</label>
                <input type="date" name="end_date" class="form-control" value="{{ current_end_date }}" placeholder="dd-mm-yyyy">
            </div>
            <div class="col-md-3">
                <label class="form-label">Search</label>
                <input type="text" name="search" class="form-control" placeholder="Plate or Email" value="{{ current_search }}">
            </div>
            <div class="col-12 text-end">
                <button type="submit" class="btn btn-primary me-2">
                    <i class="fas fa-filter me-1"></i> Apply Filters
                </button>
                <a href="{{ url_for('admin.view_reservations') }}?reset=true" class="btn btn-secondary">
    <i class="fas fa-sync me-1"></i> Reset
</a>

            </div>
        </form>
    </div>

    <!-- Reservations Table -->
    <div class="table-responsive" id="reservations-table">
        <table class="reservation-table">
            <thead>
                <tr>
                    <th>User</th>
                    <th>Vehicle Plate</th>
                    <th>Parking Spot</th>
                    <th>Parking Lot</th>
                    <th>Start Time</th>
                    <th>End Time</th>
                    <th>Status</th>
                    <th>Cost</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for reservation in reservations %}
                <tr>
                    <td>
                        <div style="font-weight:600;">{{ reservation.user.full_name }}</div>
                        <small style="color:#bfc8e2;">{{ reservation.user.email }}</small>
                    </td>
                    <td>{{ reservation.vehicle_plate }}</td>
                    <td>Spot #{{ reservation.spot.spot_number }}</td>
                    <td>{{ reservation.spot.lot.name }}</td>
                    <td>{{ reservation.start_time.strftime('%Y-%m-%d %H:%M') }}</td>
                    <td>
                        {% if reservation.end_time %}
                        {{ reservation.end_time.strftime('%Y-%m-%d %H:%M') }}
                        {% else %}
                        -
                        {% endif %}
                    </td>
                    <td>
                        {% if reservation.status == 'Active' %}
                        <span class="badge-green">Active</span>
                        {% elif reservation.status == 'Released' %}
                        <span class="badge-yellow">Released</span>
                        {% else %}
                        <span class="badge-red">Expired</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if reservation.final_cost %}
                        ₹{{ '%.2f'|format(reservation.final_cost) }}
                        {% else %}
                        -
                        {% endif %}
                    </td>
                    <td>
                        <form action="{{ url_for('admin.delete_reservation', res_id=reservation.id) }}" method="POST" style="display:inline;">
                            <button type="submit" class="action-btn delete" 
                                    onclick="return confirm('Are you sure you want to delete this reservation?');"
                                    title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </form>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="9" class="text-center py-5">
                        <i class="fas fa-calendar-times fa-3x mb-3" style="color: #7986cb;"></i>
                        <p>No reservations found</p>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}


{% block script %}
    <script>
document.addEventListener('DOMContentLoaded', function() {
    // Clear form when reset button is clicked
    const resetBtn = document.querySelector('a[href*="reset=true"]');
    if (resetBtn) {
        resetBtn.addEventListener('click', function() {
            document.querySelectorAll('.filter-card input, .filter-card select').forEach(element => {
                if (element.tagName === 'INPUT') element.value = '';
                if (element.tagName === 'SELECT') element.selectedIndex = 0;
            });
        });
    }
    
    // Clear URL after page load
    if (window.location.search.includes('reset=true')) {
        history.replaceState(null, '', window.location.pathname);
    }
});
</script>

{% endblock %}